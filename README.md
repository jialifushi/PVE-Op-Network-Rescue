# PVE-Op-Network-Rescue
一个解决网络当机的自救行动脚本


**PVE 的重启频率被严格锁死为“每天一次”**。无论你怎么调整 `L4_SOS_THRESHOLD`，PVE 这一侧的“每天一救”原则是绝对铁律。

下面我为你详细推演修改 `L4_SOS_THRESHOLD` 带来的连锁反应，以及“第二次 SOS”会发生什么。

### 1. PVE 的“一天只救一次”铁律

你在 PVE 脚本里看到的这段代码是系统的**绝对防线**：

```bash
# 每天 0 点由 Crontab 负责删除标记
if [ -f "$PVE_MARK" ]; then
    sleep 600
    continue
fi

```

**场景推演：**

1. **第一次 SOS**：OpenWrt 喊救命 -> PVE 看到信号 -> 删除信号 -> **生成 `$PVE_MARK**` -> 重启物理机。
2. **重启归来**：物理机重启完成，OpenWrt 再次启动。
3. **再次故障**：假设网络还是很烂，OpenWrt 的计数器因为没有被 PVE 清零（注意：PVE 只删了 SOS 文件，没删计数文件），OpenWrt 会**立刻**再次生成 SOS 信号。
4. **PVE 的反应**：PVE 再次巡检，看到了 SOS 信号。**但是！** 它同时也看到了 `$PVE_MARK`（今日已重启标记）。
5. **结局**：PVE 选择**“见死不救”**，直接休眠。

**结论**：PVE 确实只会重启一次。剩下的时间，OpenWrt 会一直处于“已发出 SOS”的状态躺平，直到第二天凌晨 0 点重置，或者网络突然恢复。

---

### 2. 调整 `L4_SOS_THRESHOLD` 的逻辑后果分析

目前的设置是 `15`，结合冷却机制，这几乎是一个“不可能完成的任务”。调整这个值，实际上是在调整**“介入的激进程度”**。

我为你模拟三个不同档位的后果：

#### 🟢 档位 A：极度保守 (当前值: 15)

* **逻辑**：需要 OpenWrt 在一天内疯狂重启 15 次。
* **后果**：由于有 1~3 小时的冷却机制，24 小时内很难跑满 15 次。
* **实际效果**：**PVE 几乎永远不会重启**。OpenWrt 会一直在 L1-L3 之间循环自救。
* **适用场景**：你非常信任 OpenWrt 的自愈能力，或者物理机上还跑着其他重要业务（如 NAS），绝对不想让物理机断电。

#### 🟡 档位 B：平衡策略 (推荐值: 8 ~ 10)

* **逻辑**：允许 OpenWrt 尝试 7-9 次物理重启。
* **后果**：
* 前 6 次重启（无冷却）耗时约 1 小时。
* 第 7-9 次重启（含冷却）耗时约 3-5 小时。
* **总计**：断网约 **4-6 小时** 后，触发 SOS，PVE 介入。


* **实际效果**：既给了 OpenWrt 足够的自救机会，又保证了如果大半天都修不好，PVE 会来执行“核打击”。
* **适用场景**：家用环境的最佳甜点区。

#### 🔴 档位 C：极度激进 (设定值: 5)

* **逻辑**：OpenWrt 只要重启 5 次没好，马上叫 PVE。
* **后果**：由于前 6 次没有冷却，这意味着断网 **1 小时内**，PVE 就会强制重启物理机。
* **风险**：
* 如果只是运营商短时间光缆故障（修了 2 小时），你的物理机已经被重启了。
* 浪费了 PVE 宝贵的“每日一次”复活机会。


* **适用场景**：OpenWrt 极其不稳定，一出问题必须物理重启才能好的情况。

---

### 3. 后果分析

1. 如何快速检索“哑火”记录？

你可以使用以下这条命令，一眼看出 PVE 到底有没有“调皮”：
Bash
grep -E "严重错误|回退" /var/log/pve_host_monitor.log


---


部署完成后，进行一次全面的“全系统体检”是确保这套哨兵系统长期稳定的关键。由于你现在处于模拟断网状态，你可以直接观察到脚本从“巡检”到“介入”的完整过程。

请分别在 **PVE** 和 **OpenWrt** 的终端执行以下检查动作：


---

### 4. PVE 宿主机体检 (哨兵端)

#### 1. 进程检查 (确保脚本在后台活着)

```bash
ps -eo pid,lstart,etime,cmd | grep pve_host_monitor.sh | grep -v grep

```

* **检查点**：`LSTART` 应为你刚刚启动脚本的时间。

#### 2. 定时任务检查 (确保开机自启和 0 点重置已就绪)

```bash
crontab -l | grep -E "pve_host_monitor|pve_did_reboot_today"

```

* **检查点**：应看到两条记录，一条是 `@reboot`，一条是 `0 0 * * *`。

#### 3. 日志实时监控 (最核心的检查)

```bash
tail -f /var/log/pve_host_monitor.log

```
关于日志文件不存在的解释：
原因：因为你现在的网络是通的。在你的 PVE 脚本逻辑中，只有当 ping 失败进入故障处理流程时，才会第一次调用 log_pve 函数并创建日志文件。
验证建议：你可以手动执行一次 echo "Check" >> /var/log/pve_host_monitor.log。只要文件能创建，说明权限没问题。

* **检查点**：
* 正常情况下应看到：`【检测】互联网断开...` -> `【观察】未发现 SOS 信号...`。
* 如果 OpenWrt 已经发出了 SOS，你应该看到：`【确认】捕获 SOS 信号！...`。



#### 4. 免密通讯再次确认

```bash
ssh -o ConnectTimeout=5 root@192.168.10.1 "echo 通讯正常"

```

* **检查点**：必须直接输出 `通讯正常`，不能弹密码。

---

### 5. OpenWrt 体检 (自愈端)

#### 1. 运行状态检查

```bash
# 检查计数器文件
cat /root/net_rb_count

# 检查是否有冷却标记 (如果现在正在冷却中会有这个文件)
ls -l /root/net_cooling_ts

```

#### 2. 日志活动检查

```bash
tail -n 20 /root/network_monitor.log

```

* **检查点**：看最后一行的记录时间。如果网络依然断开，你应该看到它在报错或者显示 `【SOS】停止自救`。

#### 3. 信号弹检查 (SOS 状态)

```bash
ls -l /root/SOS_SYSTEM

```

* **检查点**：如果这个文件存在，说明 OpenWrt 已经在等 PVE 来重启它了。

#### 4. 定时任务同步检查

```bash
crontab -l | grep network_monitor

```

* **检查点**：确认每分钟或每几分钟执行一次检测的逻辑是否在列。

---

### 6. 模拟实战闭环演练 (验证重启是否真的执行)

既然环境已经布好，你可以手动触发一次“完美重启”来验证：

1. **在 OpenWrt 执行**：`touch /root/SOS_SYSTEM` (手动制造一个求救信号)。
2. **回到 PVE 执行**：`tail -f /var/log/pve_host_monitor.log`。
3. **观察**：
* 你应该在几秒钟内看到 PVE 发现信号。
* 看到日志打印 `PVE 物理机将在 10 秒后执行优雅重启...`。
* **最终验证**：你的 SSH 应该被踢出，且物理机指示灯闪烁重启。




### 总结

1. **L4 阈值建议改到 8 或 10**：这样能保证 PVE 在断网半天左右介入，比现在的 15 更实用。
2. **PVE 确实一天只重启一次**。
3. **强烈建议优化 PVE 脚本**：加上上面那行“重置计数”的代码。这样 PVE 重启回来后，OpenWrt 是一张白纸，会重新开始尝试 L1 -> L2 -> L3，而不是直接躺平。
